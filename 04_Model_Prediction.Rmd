---
title: "Model prediction from the IncomeRegion model"
author: "Oluwayomi Akinfenwa"
date: "17/07/2024"
output:
  html_document:
    toc: yes
    toc_depth: '4'
    df_print: paged
  bookdown::html_document2:
    toc: no
    toc_float: yes
    toc_depth: 4
    number_sections: yes
  pdf_document:
    toc: yes
    toc_depth: '4'
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
options(knitr.duplicate.label = 'allow')
```

### Sourcing the indexing file containing the data and the country, region, income, income-region names and indexing.

```{r, data, include = FALSE}
sys.source("01_Models_Estimates.R", envir = knitr::knit_global())
```

## Loading the hierarchical models from the saved R.Data file

```{r}
#Income-Region hierarchical model
load(here::here("Manuscript_Models", "Income_region_BRMSModel.Rdata"))
```

### Pulling the posterior draws estimates for the year 2022.

ytilde estimates from the Income_region model is the prediction estimates for 2022.

we want to calculate the differences between the predicted values and the observed PISA scores for year 2022.

Recall that we didn't include the observations in our modelling, hence we chose the Income_region model to predict PISA2022 scores and visualise the differences between predicted and observed PISA2022.

```{r}
#Creating a grid of the data to make prediction for year 2022.
Pred_grid <-Pisa_Europe_Data |>
  modelr::data_grid(Country) |> 
  mutate(year = 2022, 
         year_orig = year-baseline_year) |>
  left_join(select(Names, Country, Income, Income_region),
               join_by(Country==Country))

#Income_Region hierarchical model
IR_model_pred <- Pred_grid|>
  add_predicted_rvars(Income_region_BRMSModel) |>
  rename(pred = .prediction)

#the observed values for 2022
yobserved <- Pisa_Europe_Data |>
  filter(year == "2022") # extracting the year 2022 observations

#Income-Region hierarchical model
IR_Pred <- IR_model_pred |>
  left_join(select(yobserved, Country, math), join_by(Country)) |> # selecting country and math scores from the dataset yobserved 
  mutate(Income_region= stringr::str_replace_all(Income_region, fixed("_ "),"\n"))|>
  mutate(prob = posterior::Pr(pred <= math)) |> #The probability that the predicted score is less than observed score
  mutate(math0 = math - pred) |>  # The difference between predicted and observed
          arrange(!is.na(prob), prob) |>
  mutate(Country = factor(Country, levels = Country))
```

### Visualisation.

We want to plot the differences between predicted and observed PISA scores for 2022.

```{r}
Country_flag <- Rcountry_IS_Est |>
  mutate(color = Region_flag[Region]) |>
  mutate(Group = stringr::str_replace(Group, stringr::fixed("Bosnia & Herzegovina"), "Bosnia &\nHerzegovina")) |>
  mutate(Group = stringr::str_replace(Group, stringr::fixed("United Kingdom"), "United\nKingdom")) |>
  select(Group, color)|>
  as.data.frame()

#colors for region
Reg_flag <- Region_is_Est |>
  mutate(color = Region_flag[Region]) |>
  mutate(Group = stringr::str_replace_all(Group, stringr::fixed(" "), "\n")) |>
  select(Group, color)|>
  as.data.frame()

#This is necessary for the grid of the plots to specify the strip background colors for both countries and regions.
#we rbind both color definition Reg
RegionCountry_flag <- rbind(Reg_flag, Country_flag)

# Creating grid to color the plot according to the income_region grouping
Names <- IR_Pred |>
  select(Country, Income_region, Income)

IR_colors <- c("lightsteelblue2","bisque2","#ACE1AF","lavenderblush2",
                  "bisque2","lightsteelblue2")
Income_colors <- c("magenta3", "black")

IR_flag <- setNames(IR_colors[seq_along(unique(IR_Pred$Income_region))], unique(IR_Pred$Income_region))
Income_flag <-setNames(Income_colors[seq_along(unique(Names$Income))], unique(Names$Income))

ICountry_flag <- Names |>
  mutate(strip_color = IR_flag[Income_region],
         text_color = Income_flag[Income]) |>
  select(group =Country, strip_color, text_color) |>
  as.data.frame()

Increg_flag <- IR_Pred |>
  distinct(Income_region, Income) |>
  mutate(strip_color = IR_flag[Income_region],
         text_color = Income_flag[Income]) |>
  select(group =Income_region, strip_color, text_color) |>
  as.data.frame()

#This is necessary for the grid of the plots to specify the strip background colors for regions and the text colors for both regions and countries.
#we rbind both color definition Increg_flag and ICountry_flag
IRCountry_flag <- rbind(Increg_flag, ICountry_flag)
```

#### Visualising the differences between the predicted and observed from the incomeregion model.

```{r}
# The plot
P_IR <- ggplot(data = IR_Pred)+
  geom_vline(xintercept = 0, color = "burlywood4")+
        ggdist::stat_pointinterval(aes(xdist = math0, y= Country),
                  .width = c(.50, .80, .95), point_size = 1.4, color ="grey35")+
  facet_grid(Income_region ~ ., scales = "free_y", space = "free_y", switch = "y")+ 
  labs(x ="Differences between predicted and observed PISA2022 estimates", y = " ")+
  theme_bw()+
  theme(strip.text = element_text(size = 6.3, face = "bold"),
        axis.text.y = element_text(size = 8.0),
        axis.title.x = element_text(size = 8))  # Adjust the x-axis title size

pdf("Saved_Plots/Pred_Obsv.pdf")
#creating the grid color
G <- ggplotGrob(P_IR) # for other ggplots

stripl <- which(grepl('strip-l', G$layout$name))  #the y axis names has been switch to the left, hence the reason for the strip-l
for (i in strip){
  j <- which(grepl('rect', G$grobs[[i]]$grobs[[1]]$childrenOrder))
  k <- which(grepl('text', G$grobs[[i]]$grobs[[1]]$childrenOrder))
  grobtext <- G$grobs[[i]]$grobs[[1]]$children[[k]]$children[[1]]$label
  st <- match(grobtext, Increg_flag$group)
  if (!is.na(st)){
    G$grobs[[i]]$grobs[[1]]$children[[j]]$gp$fill <- Increg_flag[st, "strip_color"]
    r <- which(grepl('text', G$grobs[[i]]$grobs[[1]]$children[[k]]$childrenOrder))
    G$grobs[[i]]$grobs[[1]]$children[[k]]$children[[r]]$gp$col <- Increg_flag[st, "text_color"]
    
  }
}

grid.draw(G)
dev.off()
```

```{r}
#TRIAL
G <- ggplotGrob(P_IR)
strip <- which(grepl('strip-l', G$layout$name))
yaxis <- which(grepl('axis-l', G$layout$name)) 
#strip <- which(grepl('strip-l|axis-l', G$layout$name))


for (i in strip){
  j <- which(grepl('rect', G$grobs[[i]]$grobs[[1]]$childrenOrder))
  k <- which(grepl('text', G$grobs[[i]]$grobs[[1]]$childrenOrder))
  grobtext <- G$grobs[[i]]$grobs[[1]]$children[[k]]$children[[1]]$label
  st <- match(grobtext, IRCountry_flag$group)
  if (!is.na(st)){
    G$grobs[[i]]$grobs[[1]]$children[[j]]$gp$fill <- IRCountry_flag[st, "strip_color"]
    r <- which(grepl('text', G$grobs[[i]]$grobs[[1]]$children[[k]]$childrenOrder))
    G$grobs[[i]]$grobs[[1]]$children[[k]]$children[[r]]$gp$col <- IRCountry_flag[st, "text_color"]
   
  for (i in seq_along(yaxis)) {
  y_grob <- G$grobs[[yaxis[i]]]
   
  if (!is.null(y_grob$childrenOrder)) {
    text_indices <- which(grepl('text', y_grob$childrenOrder))
    
    for (text_index in text_indices) {
      y_grob$children[[text_index]]$gp$col <- IRCountry_flag$text_color
    }
  }
  }
  }
}
grid.draw(G)
```

