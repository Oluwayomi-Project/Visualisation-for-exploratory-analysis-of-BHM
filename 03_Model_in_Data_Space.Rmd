---
title: "Plots for Model in the Data Space"
author: "Oluwayomi Akinfenwa"
date: "08/08/2024"
output:
  pdf_document:
    toc: yes
    toc_depth: '4'
  bookdown::html_document2:
    toc: no
    toc_float: yes
    toc_depth: 4
    number_sections: yes
  html_document:
    toc: yes
    toc_depth: '4'
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
options(knitr.duplicate.label = 'allow')
```

Creating a folder to store all the plots

```{r, libraries, include = FALSE}
if (!dir.exists(here::here("Saved_Plots")))
  dir.create(here::here("Saved_Plots"))
```

Sourcing the file containing all the data needed for this analysis from the Rmd file named: 01_PISA_Analysis_Data.Rmd.
This file contains the raw data from OECD website and all the necessary data for this analysis.

```{r loading the data}
sys.source("00_PISA_Data.R", envir = knitr::knit_global())
```

This visual displays the model in the data space by presenting the model fit on the data for each country and also the hierarchical model fit on the region data.

To illustrate the model in the data space, we use a region hierarchical model, where countries leverage the strength from their respective regional structure distribution.

$$ \text{math} \sim \; \text{year} + (1 + \text{year} | \text{Region}) + (1 + \text{year} | \text{Country}) $$

All BRMS models used for this analysis are found in a folder named: 01_Hierarchical_Models.Rmd.

Loading the region hierarchical model from the "Manuscript_Models" instead of fitting a new model entirely.

```{r}
#Region hierarchical model
load(here::here("Manuscript_Models", "Region_BRMSModel.Rdata"))
```

### Extracting the estimates from the region hierarchical model

```{r}
# Region hierarchical estimates
Region_int <- spread_rvars(Region_BRMSModel, r_Region[group1,term], b_Intercept) |>
  filter(term == "Intercept") |>
  mutate(group1 = stringr::str_replace_all(group1, fixed("."), " ")) |>
  mutate(r_Region = r_Region+ b_Intercept,
         Group = paste(group1)) |>  #We are interested in creating a group with the region names and country names for the visualisation purpose.
  rename(rvar=r_Region, Region = group1) |>
  select(Group, Region, term, rvar)

Region_slop <- spread_rvars(Region_BRMSModel, r_Region[group1,term], b_year_orig) |>
  filter(term == "year_orig") |>
  mutate(group1 = stringr::str_replace_all(group1, fixed("."), " ")) |>
  mutate(r_Region = r_Region+  b_year_orig,
         Group = paste(group1)) |>
  rename(rvar=r_Region, Region = group1)|>
  select(Group, Region, term, rvar)

Region_is <- rbind(Region_int, Region_slop) 

#Country-level estimates from the region hierarchical model
Rcountry_Int <- spread_rvars(Region_BRMSModel, r_Region[group1,term],                                 r_Country[group,term], b_Intercept) |>
                 filter(term == "Intercept") |>
mutate(group1 = stringr::str_replace_all(group1, fixed(".")," "), #group1 is region
        group = stringr::str_replace_all(group, fixed(".")," "))|> #group is country
  right_join(Names, by = join_by(group==Country,group1==Region)) |> #this join everything from the "Names" dataframe containing the country and all the grouping structure with its intercession from the model result
  mutate(r_Country = r_Country+ r_Region+ b_Intercept) |> #Adding the global estimates, region offsets and the country offsets
  rename(rvar=r_Country, Region=group1, Group =group) |> # for the country estimate, country names will be the group
  select(Group, Region, term, rvar)

Rcountry_Slop <- spread_rvars(Region_BRMSModel, r_Region[group1,term],r_Country[group,term],b_year_orig) |>
  filter(term == "year_orig") |>
  mutate(group1 = stringr::str_replace_all(group1, fixed("."), " "), 
         group = stringr::str_replace_all(group, fixed("."), " ")) |>
  right_join(Names, by = join_by(group==Country,group1==Region)) |>
  mutate(r_Country =  r_Country+ r_Region+ b_year_orig) |>
  rename(rvar=r_Country,Region=group1, Group =group) |>
  select(Group,Region, term, rvar)

Rcountry_IS <- rbind(Rcountry_Int, Rcountry_Slop)
```

#### Tidying the model estimates.

```{r}
#Calculating the median value.
Region_is_est <- Region_is |> mutate(coef=median(rvar))|> 
  select(-rvar)|>
  pivot_wider(values_from=coef, names_from=term) |>
  rename(Slope = year_orig)

Rcountry_IS_est <- Rcountry_IS |> mutate(coef=median(rvar))|> 
  select(-rvar)|>
  pivot_wider(values_from=coef, names_from=term) |>
  rename(Slope = year_orig)

#We want to create a variable with the slopesign and a variable to order the countries in ascending slope.
Region_is_Est <- Region_is_est |> 
  mutate(slopesign = sign(Slope), #Adding sign (-ve or +ve)
         order_slope = Slope +min(Rcountry_IS_est$Slope)) |> #Adding the min slope from the country estimates from the hierarchy estimates, to ensure that the estimates for hierarchy are the least for the sake of positioning the hierarchical estimates on the first column of each panel
        #order_slope = Slope +max(Rcountry_IS_est$Slope)) |> #If we are interested in positioning the hierarchy plot on the right.
  arrange(Slope) |> # Arranging the Region in increasing slope
  mutate(Region = factor(Region, levels = Region))

Rcountry_IS_Est <- Rcountry_IS_est |> 
  mutate(slopesign = sign(Slope),
         order_slope = Slope,
         Region = factor(Region,
                         levels = Region_is_Est$Region)) |>
  arrange(Region, Slope) #factoring the Region column in Rcountry based on the order of Region from the hierarchical estimates (In increasing slope)

# To create our plot
# Let's try merging the estimates for region hierarchy and country level together.
Region_Int.Slop <- rbind(Region_is_Est, Rcountry_IS_Est)

## The above is rightly done, Instead of ordering the Region levels manually,
## I have it ordered by Increasing slope of the Region hierarchical estimates.

##Merging the slope-sign with the Pisa data so that we can rearrange by both country and slope-sign

# Bearing in mind that the slope estimates for the Country-level is different from the hierarchical estimates.
# Hence, we are joining the slope-sign from the country-level to the PISA data as PISA_Europe_Data1 and the slope-sign from the hierarchy estimates to the PISA data as PISA_Europe_Data_Reg.

  PISA_Europe_Data1 <- PISA_Europe_Data |>
          left_join(select(Rcountry_IS_Est, Group, order_slope), #selecting the Group and the slope ordering
                    join_by(Country ==Group)) |>
  mutate(Region = factor(Region,
                         levels = Region_is_Est$Region)) |> # Recall the levels of the hierarchical estimates in increasing slopes
  arrange(Region) |>
  select(Group = Country, Region, year, math, year_orig, order_slope)
  
#Duplicating it for Region
PISA_Europe_Data_Reg <- PISA_Europe_Data |>
          left_join(select(Region_is_Est, Group, order_slope), #selecting the Group and the slope ordering 
                    join_by(Region ==Group)) |>
  mutate(Group = Region,
         Region = factor(Region,
                         levels = Region_is_Est$Region)) |>
  arrange(Region) |>
  select(Group, Region, year, math, year_orig, order_slope)

### Can we merge both PISA_Europe_Data1 and PISA_Europe_Data_Reg
Merged_Data <- rbind(PISA_Europe_Data1, PISA_Europe_Data_Reg)
```

#### Visualising the region model fit on each country with the hierarchy fit on each region - Grouping by region.

```{r}
## Our interest is to create a data frame with both region and country assigning colors to them.
#Defining colors to represent the hierarchical structures uniquely
Region_colors <- c("#ACE1AF","lavenderblush2","lightsteelblue2","bisque2")
Region_flag <-setNames(Region_colors[seq_along(unique(Region_is_Est$Region))], unique(Region_is_Est$Region))

#Countries in the same region will be presented using the same strip background color
#colors for countries
Country_flag <- Rcountry_IS_Est |>
  mutate(color = Region_flag[Region]) |>
  mutate(Group = stringr::str_replace(Group, stringr::fixed("Bosnia & Herzegovina"), "Bosnia &\nHerzegovina")) |>
  mutate(Group = stringr::str_replace(Group, stringr::fixed("United Kingdom"), "United\nKingdom")) |>
  select(Group, color)|>
  as.data.frame()

#colors for region
Reg_flag <- Region_is_Est |>
  mutate(color = Region_flag[Region]) |>
  mutate(Group = stringr::str_replace_all(Group, stringr::fixed(" "), "\n")) |>
  select(Group, color)|>
  as.data.frame()

#This is necessary for the grid of the plots to specify the strip background colors for both countries and regions.
#we rbind both color definition Reg_flag and country_flag
RegionCountry_flag <- rbind(Reg_flag, Country_flag)
```


```{r}
pdf("Saved_Plots/Region_fit+hierachy_est.pdf",
    height = 4.8)
P <- ggplot(data = Merged_Data,
            aes(x=year_orig, y=math))+
  geom_point(color = "grey35", size = 1.1)+
  geom_abline(data= Region_Int.Slop, 
              aes(slope=Slope, intercept= Intercept, color = factor(slopesign))) +
   facet_ragged_rows(vars(facet = Region), 
                     #vars(Group),
                    vars(reorder(Group, order_slope)),
                    scales = "free_y", switch = "y",
                  labeller=label_wrap_gen(width=9))+
  scale_x_continuous(breaks = seq(-15,0,3),labels = function(x) x+2018) +
  scale_y_continuous(position = "right")+
  labs(x= " ", y = " ",  color = "Slope") + 
  scale_color_manual(values = c("firebrick2", "blue"), labels = c("negative", "positive"), na.translate = F)+
  theme(legend.position = "none",
        panel.spacing.y = unit(1.2, "lines"),
        plot.subtitle = element_text(family = "Serif"),
        axis.text.x = element_text(angle = 61, hjust = 0.5, vjust = 0.5,size =5.05, face = "bold"),strip.text.x = element_text(size = 4.5,face = "bold"),
        strip.text.y = element_text(size = 6.65,face = "bold"),
        axis.text.y = element_text(size = 5.9,face = "bold"))

G <- ggplotGrob(P)
# g$layout$name
Strip <- which(grepl('strip', G$layout$name)) 


for (i in Strip){
  j <- which(grepl('rect', G$grobs[[i]]$grobs[[1]]$childrenOrder))
  k <- which(grepl('text', G$grobs[[i]]$grobs[[1]]$childrenOrder))
  grobtext <- G$grobs[[i]]$grobs[[1]]$children[[k]]$children[[1]]$label
  st <- match(grobtext, RegionCountry_flag$Group)
  if (isTRUE( !is.na(st))){
    G$grobs[[i]]$grobs[[1]]$children[[j]]$gp$fill <- RegionCountry_flag[st, "color"]
  }
}

grid.draw(G)

dev.off()
```