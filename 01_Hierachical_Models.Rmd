---
title: "The Independent model, Bayesian hierarchical models for Country-specific, Region, Income and Income-region"
author: "Oluwayomi Akinfenwa"
date: "06/08/2024"
output:
  html_document:
    toc: yes
    toc_depth: '4'
    df_print: paged
  bookdown::html_document2:
    toc: no
    toc_float: yes
    toc_depth: 4
    number_sections: yes
  pdf_document:
    toc: yes
    toc_depth: '4'
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
options(knitr.duplicate.label = 'allow')
```

Sourcing the file containing all the data needed for this analysis from the Rmd file named: 01_PISA_Analysis_Data.Rmd.
This file contains the raw data from OECD website and all the necessary data for this analysis.

```{r loading the data}
sys.source("00_PISA_Data.R", envir = knitr::knit_global())
```

**We have decided to use BRMS for this analysis**

*Setting the model specification in BRMS*

```{r}
#library(cmdstanr)
options(mc.cores = 4
    #brms.backend = "cmdstanr"
)
#Setting the seed
bayes_seed <-1234
```

Creating a folder to store all the plots

```{r, libraries, include = FALSE}
if (!dir.exists(here::here("Manuscript_Models")))
  dir.create(here::here("Manuscript_Models"))
```

#### Independent model with gloabl mean as the slope.

```{r}
if (file.exists(here::here("Manuscript_Models", "CountryInd_BRMSModel.Rdata"))){
  load(here::here("Manuscript_Models", "CountryInd_BRMSModel.Rdata"))
  genBRMS <- FALSE
} else genBRMS <- TRUE

```

```{r, message=FALSE, eval= genBRMS}
#For the Independent linear model, we are interested in fitting a linear model omitting the countries with one data point.
#Hence, we will use the SPISA_Europe_Data for this model fitting.

S_Priors <- c(brms::prior(normal(500, 100), class = Intercept),
            brms::prior(normal(0, 50), class = b),
            brms::prior(cauchy(30, 100), class = sigma))

CountryInd_BRMSModel <- brms::brm(
  brms::bf(math ~ (year_orig*Country)),
  data = SPISA_Europe_Data,
  iter = 12000, 
  prior = S_Priors,
  save_pars = save_pars(all = TRUE),
  control = list(adapt_delta = 0.99, max_treedepth = 25),
  silent = 2, chains = 4, seed = bayes_seed)

save(CountryInd_BRMSModel, file=here::here("Manuscript_Models", "CountryInd_BRMSModel.Rdata"))
```

```{r}
if (file.exists(here::here("Manuscript_Models", "Country_BRMSModel.Rdata"))){
  load(here::here("Manuscript_Models", "Country_BRMSModel.Rdata"))
  genBRMS <- FALSE
} else genBRMS <- TRUE

```

#### Country-specific model with a distribution on all the country.

```{r, message=FALSE, eval= genBRMS}

C_Priors <- c(brms::prior(normal(500, 100), class = Intercept),
            brms::prior(normal(0, 5), class = b),
            brms::prior(cauchy(30, 10), class = sigma),
            brms::prior(cauchy(30, 10), class = sd, coef = Intercept, group=Country),
            brms::prior(cauchy(0, 2), class = sd, coef = year_orig, group=Country))


Country_BRMSModel <- brms::brm(
  brms::bf(math ~ year_orig + (1 + year_orig|Country)),
  data = PISA_Europe_Data,
  iter = 12000, 
  prior = C_Priors,
  save_pars = save_pars(all = TRUE),
  control = list(adapt_delta = 0.93),
  chains = 4, seed = bayes_seed)

save(Country_BRMSModel, 
     file=here::here("Manuscript_Models", "Country_BRMSModel.Rdata"))
```

```{r}
if (file.exists(here::here("Manuscript_Models", "Region_BRMSModel.Rdata"))){
  load(here::here("Manuscript_Models", "Region_BRMSModel.Rdata"))
  genBRMS <- FALSE
} else genBRMS <- TRUE

```

Running the brms model for region hierarchical model

```{r, message=FALSE, eval= genBRMS}

R_Priors<- c(brms::prior(normal(500, 100), class = Intercept),
          brms::prior(normal(0, 5), class = b),
          brms::prior(cauchy(30, 10), class = sigma),
          brms::prior(cauchy(0, 5), class = sd, coef = Intercept, group= Region),
          brms::prior(cauchy(0, 2), class = sd, coef = year_orig, group= Region),
          brms::prior(cauchy(30, 10), class = sd, coef = Intercept, group= Country),
          brms::prior(cauchy(0, 2), class = sd, coef = year_orig, group= Country))

Region_BRMSModel <- brms::brm(
  brms::bf(math ~ year_orig + (1 + year_orig|Region)+ (1 + year_orig|Country)),
  data = PISA_Europe_Data,
  iter = 12000, 
  prior = R_Priors,
  save_pars = save_pars(all = TRUE),
  control = list(adapt_delta = 0.99, max_treedepth = 20), silent=2,
  chains = 4, seed = bayes_seed)

save( Region_BRMSModel,
      file=here::here("Manuscript_Models", "Region_BRMSModel.Rdata"))
```

Running the brms model for income hierarchical model

```{r}
if (file.exists(here::here("Manuscript_Models", "Income_BRMSModel.Rdata"))){
  load(here::here("Manuscript_Models", "Income_BRMSModel.Rdata"))
  GenBRMS <- FALSE
} else GenBRMS <- TRUE

```

```{r, message=FALSE, eval= GenBRMS}

I_Priors<-  c(brms::prior(normal(500, 100), class = Intercept),
          brms::prior(normal(0, 5), class = b),
          brms::prior(cauchy(30, 10), class = sigma),
          brms::prior(cauchy(0, 5), class = sd, coef = Intercept, group= Income),
          brms::prior(cauchy(0, 2), class = sd, coef = year_orig, group= Income),              brms::prior(cauchy(30, 10), class = sd, coef = Intercept, group= Country),
          brms::prior(cauchy(0, 2), class = sd, coef = year_orig, group= Country))


Income_BRMSModel <- brms::brm(
  brms::bf(math ~ year_orig + (1 + year_orig|Income)+ (1 + year_orig|Country)),
  data = PISA_Europe_Data,
  iter = 12000, 
  prior = I_Priors,
  save_pars = save_pars(all = TRUE),
  control = list(adapt_delta = 0.997, max_treedepth = 20), silent=2,
  chains = 4, seed = bayes_seed)

save(Income_BRMSModel,
      file=here::here("Manuscript_Models", "Income_BRMSModel.Rdata"))
```

Running the brms model for Income-region hierarchical model

```{r}
if (file.exists(here::here("Manuscript_Models", "Incomeregion_BRMSModel.Rdata"))){
  load(here::here("Manuscript_Models", "Incomeregion_BRMSModel.Rdata"))
  GenBRMS <- FALSE
} else GenBRMS <- TRUE

```

```{r, message=FALSE, eval= GenBRMS}

IR_Priors <- c(brms::prior(normal(500, 100), class = Intercept),
        brms::prior(normal(0, 5), class = b),
      brms::prior(cauchy(30, 10), class = sigma),
      brms::prior(cauchy(0, 5), class = sd, coef = Intercept, group= Income_region),
      brms::prior(cauchy(0, 2), class = sd, coef = year_orig, group= Income_region),
      brms::prior(cauchy(30, 10), class = sd, coef = Intercept, group= Country),
      brms::prior(cauchy(0, 2), class = sd, coef = year_orig, group= Country))

Income_region_BRMSModel <- brms::brm(
  brms::bf(math ~ year_orig + (1 + year_orig|Income_region)+ (1 + year_orig|Country)),
  data = PISA_Europe_Data,
  iter = 12000, 
  prior = IR_Priors,
  save_pars = save_pars(all = TRUE),
  control = list(adapt_delta = 0.999, max_treedepth = 15), silent=2,
  chains = 4, seed = bayes_seed)

save(Income_region_BRMSModel,
      file=here::here("Manuscript_Models", "Income_region_BRMSModel.Rdata"))
```

#### Model comparison tests using LOO-Compare

```{r}
fit1 <- add_criterion(CountryInd_BRMSModel, "loo", moment_match = TRUE)

fit2 <- add_criterion(Country_BRMSModel, "loo",
                      moment_match = TRUE)

fit3 <- add_criterion(Region_BRMSModel, "loo",
                      moment_match = TRUE)

fit4 <- add_criterion(Income_BRMSModel, "loo",
                      moment_match = TRUE)

fit5 <- add_criterion(Income_region_BRMSModel, "loo",
                      moment_match = TRUE)

#Comparing all the models
loo_compare(fit2, fit3, fit4, fit5, criterion = "loo")
```

The results above shows that model 1 (the independent linear model is the worse model), followed by the model 3(Region hierarchical model) and the best are the Country-specific model, the Income-region model.

One of the advantages of the our proposed visualisation approach is its ability to collectively compare different models. Based on our visual, we choose fit 5 (the income_region hierarchical model as the best model).